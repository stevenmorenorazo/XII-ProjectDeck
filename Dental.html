<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dental Providers ‚Ä¢ UC Ship Finder</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: #003660;
      color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .top-bar {
      background-color: #002a47;
      width: 100%;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .top-bar-title {
      color: #FFCE34;
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      display: inline-block;
      transition: opacity 0.3s ease;
    }

    .top-bar-title:hover {
      opacity: 0.8;
    }

    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 500;
    }

    .layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 25px;
    }

    .filters {
      background-color: #002a47;
      padding: 20px;
      border-radius: 10px;
    }

    .filters h2 {
      margin-bottom: 15px;
      font-size: 1.3rem;
      color: #FFCE34;
    }

    .filter-group { margin-bottom: 20px; }

    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
    }

    .location-btn {
      width: 100%;
      padding: 12px;
      background-color: #d6b704;
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    .location-btn:hover { background-color: #aa8e32; }

    .providers {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .provider-card {
      display: grid;
      grid-template-columns: 180px 1fr;
      background-color: #002a47;
      border-radius: 12px;
      overflow: hidden;
    }

    /* ‚úÖ Clickable image (opens Google Maps) */
    .provider-image-link {
      display: block;
      width: 180px;
      cursor: pointer;
    }

    .provider-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s ease, filter 0.2s ease;
    }

    .provider-image-link:hover img {
      transform: scale(1.03);
      filter: brightness(0.92);
    }

    .provider-info { padding: 15px; }

    .provider-info h3 {
      margin-bottom: 6px;
      font-size: 1.2rem;
    }

    .rating {
      color: #FFCE34;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .provider-info p {
      font-size: 0.95rem;
      margin-bottom: 10px;
      color: #d9e6f2;
    }

    .provider-meta {
      font-size: 0.9rem;
      margin-bottom: 10px;
      color: #d9e6f2;
      line-height: 1.35;
    }

    /* ‚úÖ Embedded Google Maps preview (no API key) */
    .map-preview iframe {
      width: 100%;
      height: 180px;
      border: 0;
      border-radius: 10px;
      margin-top: 10px;
    }

    .provider-links a {
      display: inline-block;
      margin-right: 10px;
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #d6b704;
      color: #000;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .provider-links a:hover { background-color: #aa8e32; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }

      .provider-card { grid-template-columns: 1fr; }

      .provider-image-link { width: 100%; }

      .provider-card img { height: 220px; }
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="top-bar-title" onclick="window.location.href='index.html'">UC Ship finder</div>
  </div>

  <div class="main">
    <h1>Dental Providers Near UCSB</h1>

    <div class="layout">
      <!-- FILTERS -->
      <div class="filters">
        <h2>Filter</h2>

        <div class="filter-group">
          <label>Sort by</label>
          <select id="sort">
            <option value="distance">Proximity</option>
            <option value="rating">Rating</option>
            <option value="name-asc">Name (A‚ÄìZ)</option>
            <option value="name-desc">Name (Z‚ÄìA)</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Minimum rating</label>
          <select id="minRating">
            <option value="0">Any</option>
            <option value="4">4.0+</option>
            <option value="4.5">4.5+</option>
          </select>
        </div>

        <button class="location-btn" onclick="getLocation()">Use my location</button>
        <p id="locationStatus" style="margin-top:10px;font-size:0.85rem;"></p>
      </div>

      <div class="providers" id="providers"></div>
    </div>
  </div>

  <script>
    let userLocation = null;

    async function getLocation() {
      const status = document.getElementById("locationStatus");
      if (!navigator.geolocation) {
        status.textContent = "Geolocation is not supported by your browser.";
        return;
      }

      status.textContent = "Getting your location‚Ä¶";

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          status.textContent = "Geocoding provider addresses...";

          // First, ensure all providers have accurate coordinates
          await ensureProviderCoordinates();

          // Update status and calculate distances
          status.textContent =
            `Location enabled ‚úì (${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)})`;

          // Re-render with calculated distances
          renderProviders();
        },
        (error) => {
          status.textContent = "Unable to retrieve your location.";
          console.error('Geolocation error:', error);
        }
      );
    }

    const providers = [
      {
        name: "Isla Vista Family Dentistry",
        rating: 4.6,
        description: "General and cosmetic dentistry. Student-friendly scheduling and UC SHIP billing.",
        phone: "(805) 555-1234",
        address: "5901 Encina Rd Ste C1, Goleta, CA, 93117",
        lat: null, // Will be geocoded when location is enabled
        lng: null,
        img: "https://images.unsplash.com/photo-1588776814546-1ffcf47267a5?auto=format&fit=crop&w=800&q=60"
      },
      {
        name: "Downtown Santa Barbara Dental",
        rating: 4.8,
        description: "Preventive care, cleanings, and emergency visits. Accepting new patients.",
        phone: "(805) 555-9876",
        address: "123 State St, Santa Barbara, CA",
        lat: null, // Will be geocoded when location is enabled
        lng: null,
        img: "https://images.unsplash.com/photo-1606813907291-d86efa9b94db?auto=format&fit=crop&w=800&q=60"
      }
    ];

    // Geocode addresses using OpenStreetMap Nominatim (free, no API key needed)
    async function geocodeAddress(address) {
      try {
        // Using a free geocoding service (Nominatim)
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
          {
            headers: {
              'User-Agent': 'UC Ship Finder'
            }
          }
        );
        
        if (!response.ok) {
          console.error(`Geocoding API error: ${response.status} ${response.statusText}`);
          return null;
        }
        
        const data = await response.json();
        if (data && Array.isArray(data) && data.length > 0 && data[0].lat && data[0].lon) {
          const lat = parseFloat(data[0].lat);
          const lng = parseFloat(data[0].lon);
          
          // Validate the coordinates
          if (!isNaN(lat) && !isNaN(lng) && 
              Math.abs(lat) <= 90 && Math.abs(lng) <= 180) {
            return { lat, lng };
          } else {
            console.error(`Invalid coordinates returned: lat=${lat}, lng=${lng}`);
          }
        } else {
          console.warn(`No results found for address: ${address}`);
        }
      } catch (error) {
        console.error(`Geocoding error for "${address}":`, error);
      }
      return null;
    }

    // Ensure all providers have accurate coordinates (geocode if needed)
    async function ensureProviderCoordinates() {
      // Geocode all providers that need it
      for (let i = 0; i < providers.length; i++) {
        const provider = providers[i];
        // Geocode if coordinates are missing, invalid, or seem incorrect
        if (provider.lat == null || provider.lng == null || 
            isNaN(provider.lat) || isNaN(provider.lng) ||
            Math.abs(provider.lat) > 90 || Math.abs(provider.lng) > 180 ||
            provider.lat === 0 || provider.lng === 0) {
          console.log(`Geocoding ${provider.name}...`);
          const coords = await geocodeAddress(provider.address);
          if (coords && coords.lat != null && coords.lng != null && 
              !isNaN(coords.lat) && !isNaN(coords.lng)) {
            provider.lat = coords.lat;
            provider.lng = coords.lng;
            console.log(`‚úì Geocoded ${provider.name}: ${coords.lat}, ${coords.lng}`);
          } else {
            console.warn(`‚úó Failed to geocode ${provider.name} at ${provider.address}`);
          }
          // Add a small delay to respect rate limits (1 request per second)
          if (i < providers.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        } else {
          console.log(`‚úì ${provider.name} already has coordinates: ${provider.lat}, ${provider.lng}`);
        }
      }
    }

    function distanceMiles(a, b) {
      const toRad = (deg) => deg * Math.PI / 180;
      const R = 6371000; // meters
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);

      const h =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;

      const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
      const meters = R * c;
      return meters / 1609.344;
    }

    function renderProviders() {
      const container = document.getElementById("providers");
      const sortValue = document.getElementById("sort").value;
      const minRating = parseFloat(document.getElementById("minRating").value || "0");

      container.innerHTML = "";

      // Calculate distances from user location to each provider
      let shownProviders = [...providers]
        .filter(p => p.rating >= minRating)
        .map(p => {
          // Only calculate distance if user location is available and provider has valid coordinates
          if (userLocation) {
            // Check if provider has valid coordinates
            if (p.lat != null && p.lng != null && 
                !isNaN(p.lat) && !isNaN(p.lng) &&
                Math.abs(p.lat) <= 90 && Math.abs(p.lng) <= 180 &&
                p.lat !== 0 && p.lng !== 0) {
              try {
                const distance = distanceMiles(userLocation, { lat: p.lat, lng: p.lng });
                if (!isNaN(distance) && isFinite(distance) && distance >= 0) {
                  console.log(`Distance for ${p.name}: ${distance.toFixed(2)} miles`);
                  return { ...p, distance: distance };
                } else {
                  console.warn(`Invalid distance calculated for ${p.name}: ${distance}`);
                }
              } catch (error) {
                console.error(`Error calculating distance for ${p.name}:`, error);
              }
            } else {
              console.warn(`Invalid coordinates for ${p.name}: lat=${p.lat}, lng=${p.lng}`);
            }
          }
          return { ...p, distance: null };
        });

      if (sortValue === "distance") {
        shownProviders.sort((a, b) => (a.distance ?? Infinity) - (b.distance ?? Infinity));
      } else if (sortValue === "rating") {
        shownProviders.sort((a, b) => b.rating - a.rating);
      } else if (sortValue === "name-asc") {
        shownProviders.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortValue === "name-desc") {
        shownProviders.sort((a, b) => b.name.localeCompare(a.name));
      }

      shownProviders.forEach(p => {
        const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.address)}`;
        const telLink = `tel:${String(p.phone).replace(/\D/g, "")}`;

        container.innerHTML += `
          <div class="provider-card">
            <a class="provider-image-link" href="${mapsLink}" target="_blank" rel="noopener noreferrer" aria-label="Open ${p.name} in Google Maps">
              <img src="${p.img}" alt="${p.name}">
            </a>

            <div class="provider-info">
              <h3>${p.name}</h3>

              <div class="rating">
                ‚òÖ ${p.rating}
              </div>

              ${p.distance != null ? `<div style="color: #FFCE34; font-weight: 600; margin-bottom: 10px; font-size: 0.95rem;">üìç ${p.distance.toFixed(1)} mi away</div>` : ''}

              <p>${p.description}</p>

              <div class="provider-meta">
                üìç ${p.address}<br>
                üìû ${p.phone}
              </div>

              <div class="map-preview">
                <iframe
                  src="https://www.google.com/maps?q=${encodeURIComponent(p.address)}&output=embed"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade">
                </iframe>
              </div>

              <div class="provider-links">
                <a href="${telLink}">Call</a>
              </div>
            </div>
          </div>
        `;
      });
    }

    document.getElementById("sort").addEventListener("change", renderProviders);
    document.getElementById("minRating").addEventListener("change", renderProviders);

    renderProviders();
  </script>
</body>
</html>
